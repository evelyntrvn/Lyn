<head> </head>

<body>
  <audio><source src="./public/audio/tokyo_tea.mp3"> </audio> 
  <div id="loading">
    <div class="loading-container">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
  </div>
  
  <div id="infoContainer">
    <div class="iconContainer">
      <img id="shuffleIcon" class="icon" src="./public/img/shuffle.png" />
      <img id="helpIcon" class="icon" src="./public/img/help.png" />
    </div>
  </div>

  <!-- POPUPS -->
  <div class="popup" id="helpPopup">
    <h1>Command List</h1>

    <!-- TABS -->
    <div class="tab-header">
      <div class="active-tab">
        <i class="ref-tab"></i> Let's Begin!
      </div>
      <div>
        <i class="ref-tab"></i> Simulation
      </div>
      <div >
        <i class="ref-tab"></i> Audio
      </div>
      <div>
        <i class="ref-tab"></i> Shapes & Colors
      </div>
      <div>
        <i class="ref-tab"></i> Effects
      </div>
    </div>

    <div class="tab-indicator"></div>
    <div class="tab-body">

      <div class="active-tab">
        <h2>Let's Begin</h2>
  
          <p>This is Lyn, a live-coding platform based on creating artificial life simulations.</p>
          <p>To begin, all you have to do is type out your code and then click CTRL + ENTER to run it.</p>
          <p>To run one line or a selection, click SHIFT + ENTER</p>
      </div>

      <div>
        <h2>Simulations</h2>
  
          <p>diffuse(true)     start reactive diffusion function with true; stop with false</p>
          <p>dA(rateA)       set diffusion rate of A; best between 0-1; can set to audio</p>
          <p>dB(rateB)      set diffusion rate of B; best between 0-1; can set to audio</p>
          <p>feed(feedRate)     set feed rate; best between 0-1; can set to audio</p>
          <p>kill(killRate)     set kill rate; best between 0-1; can set to audio</p>

          <p>automata(true)     start cellular automata function with true; stop with false</p>
      </div>

      <div>
        <h2>Audio</h2>
        1 <input type="file" class="audio-input"></input> <br>
        2 <input type="file" class="audio-input"></input> <br>
        3 <input type="file" class="audio-input"></input> <br>

        playMusic(trackNumber)   Upload an audio file above; The trackNumber corresponds track above <br> 
        pauseMusic()    Pauses the audio
      </div>

      <div>
        <h2>Shapes & Colors</h2>
          <p>rect(xPos, yPos, width, height)   draw a rectangle </p>
          <p>reset()   clears the screen</p><br>

          <p>colorA(#ffffff)  set colorA to the hex code inside</p>
          <p>colorB(#000000)  set colorB to the hex code inside</p>
          
      </div>

      <div>
        <h2>Effects</h2>
          <p>kal()       adds a kaleidoscope effect</p>
          <p>oldFilm()   adds an old film effect</p>
          <p>noise()     adds a noise effect</p>
          <p>vignette()  adds a vignette effect</p> 
          <p>noEffect()      clears any effects</p>
      </div>

    </div>

   
  </div>
  <div class="overlay" id="popupContainer">
  </div>

  <div id="editor"></div>
  <canvas id="gl"></canvas>

  <div id="paramContainer">
    <button id='paramB' class="collapsible">Parameters</button>

    <div class="paramContent" id="textParams"></div>
    <div class="paramContent" id="graphParams"></div>
  </div>

  <canvas id="processed"></canvas>
</body>

<link rel="stylesheet" href="style.css" />

<script src="https://unpkg.com/codemirror@5.65.9/lib/codemirror.js"></script>
<script src="https://unpkg.com/codemirror-colorpicker@1.9.80/dist/codemirror-colorpicker.js"></script>

<script src="https://d3js.org/d3.v4.js"></script>
<link rel="stylesheet" href="https://unpkg.com/codemirror@5.65.9/lib/codemirror.css"/>
<link rel="stylesheet" href="https://unpkg.com/codemirror-colorpicker@1.9.80/dist/codemirror-colorpicker.css" />


<script src="https://cdn.jsdelivr.net/npm/tweakpane@3.0.7/dist/tweakpane.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/peggy"></script>

<!-- vertex shader, as simple as possible - -->
<script id="vertex" type="x-shader/x-vertex">
  attribute vec2 a_position;

  void main() {
    gl_Position = vec4( a_position, 0, 1 );
  }
</script>

<script id="simulation" type="x-shader/x-fragment">
  #ifdef GL_ES
      precision mediump float;
  #endif

  uniform float time;
  uniform vec2 resolution;
  uniform float dA;
  uniform float dB;
  uniform float feed;
  uniform float kill;
  uniform float size;
  uniform float audioData;
  uniform bool diffuse; 
  uniform bool automata;

  // simulation texture state, swapped each frame
  uniform sampler2D state;

  // get each cell rgb
  vec3 get(int x, int y) {
    return vec3(
      texture2D( state, ( gl_FragCoord.xy + vec2(x, y) ) / resolution ).rgb
    );
  }

  // get prev state
  vec4 getPrev() {
    return texture2D( state, ( gl_FragCoord.xy ) / resolution );
  }

  vec3 laplace(){
    vec3 sum = vec3(0., 0., 0.);

    sum = get(-1, -1) * 0.05
        + get( 0, -1) * 0.2
        + get( 1, -1) * 0.05
        + get(-1, 0) * 0.2
        - get( 0, 0)
        + get( 1, 0) * 0.2
        + get(-1 , 1) * 0.05
        + get( 0, 1) * 0.2
        + get( 1, 1) * 0.05;

    return sum;
  }

  vec4 dif(){
    float a = get(0, 0).r;
    float b = get(0, 0).g;
    vec3 lp = laplace();

    float reaction = a*b*b;

    float a2 = a + (dA * lp.x - reaction + feed * (1. - a));
    float b2 = b + (dB * lp.y + reaction - (kill + feed) * b);

    vec4 result = vec4(a2, b2, audioData, 1.);
    return result;
  }

  vec4 auto(){
    vec4 result = vec4(0.);
    float state = get(0,0).g;     //current state

    float neighbor = get(-1, -1).g + // neighbor count
              get(-1,  0).g +
              get(-1,  1).g +
              get( 0, -1).g +
              get( 0,  1).g +
              get( 1, -1).g +
              get( 1,  0).g +
              get( 1,  1).g;

    if (state == 0. && neighbor == 3.){  //lonely and dies
      result = vec4( 0., 1., 0., 1.);
    }else if (state == 1. && (neighbor < 2. || neighbor > 3.)) {
      result = vec4( 1., 0., 0., 1. );
    } else {
      result = vec4( get(0,0), 1. );
    }
    return result;
  }

  void main() {
    vec4 result = getPrev();

    if (diffuse){
      result = dif();
    }else if (automata){
      result = auto();
    }else{
      result = getPrev();
    }

    gl_FragColor = result;
  }
</script>

<!-- render to screen shader -->
<script id="render" type="x-shader/x-fragment">
  #ifdef GL_ES
  precision mediump float;
  #endif

  uniform sampler2D uSampler;
  uniform vec2 resolution;
  uniform vec3 colA;
  uniform vec3 colB;

  vec4 grayscale(){
    vec4 cur = vec4( texture2D( uSampler, gl_FragCoord.xy / resolution ).rgb, 1. );
    float gray = (cur.r*0.21 + cur.g*0.71 + cur.b*0.07);
    float colorFactor = 1.;

    return vec4(cur.rgb * (1. - colorFactor) + gray * colorFactor, cur.a);
  }

  vec4 colorscale(vec3 colA, vec3 colB){
    vec4 cur = vec4( texture2D( uSampler, gl_FragCoord.xy / resolution ).rgb, 1. );
    vec3 a = colA * cur.r;
    vec3 b = colB * cur.g;

    return vec4( a + b, cur.a );
  }

  void main() {
  
    gl_FragColor = colorscale(colA, colB); //grayscale();

  }
</script>

<script type="module" src="main.js"></script>
